#!/usr/bin/env bash

# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

# Verifies that the code generated by yardl init and yardl generate
# can be built and run on macOS.

set -euo pipefail

brew install hdf5 xtensor howard-hinnant-date

cd "$(dirname "$0")"

rm -rf model

yardl init smoketest

cd model
yardl generate

cd ../cpp
rm -rf build
mkdir build
cd build

cmake ..
cmake --build .

# Run the binary we just built
./smoketest

# Verify that it produced the expected file
if [ ! -f smoketest.h5 ]; then
    echo "Error: the expected output file was not found"
    exit 1
fi

h5dump smoketest.h5