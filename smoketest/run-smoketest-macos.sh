#!/usr/bin/env bash

# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

# Verifies that the code generated by yardl init and yardl generate
# can be built and run on macOS.

set -euo pipefail

cd "$(dirname "$0")"

rm -rf model

# Create model
yardl init smoketest

cd model
yardl generate

cd ..

# Verify python
pip3 install numpy
python3 python/run_smoketest.py

# Verify C++
brew install hdf5 xtensor howard-hinnant-date nlohmann-json

cd cpp
rm -rf build
mkdir build
cd build

cmake ..
cmake --build .

# Run the binary we just built
./smoketest

# Verify that it produced the expected file
if [ ! -f smoketest.h5 ]; then
    echo "Error: the expected output file was not found"
    exit 1
fi

h5dump smoketest.h5


## add the unit test types to the model and make sure it compiles
echo "Adding unit test types to the model"
cd ../..
cp ../models/test/unittests.yml model/
cd model
yardl generate
cd ../cpp/build
cmake --build .
