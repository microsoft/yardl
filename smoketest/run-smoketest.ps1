# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

# Verifies that the code generated by yardl init and yardl generate
# can be built and run on Windows.

param(
    [string]$VcpkgPath="C:\vcpkg"
)

$ErrorActionPreference = "Stop"

$location = Get-Location

try
{
    $scriptDir = Split-Path -Parent $MyInvocation.MyCommand.Definition

    cd $scriptDir
    rm -Recurse -Force model -ErrorAction SilentlyContinue

    # Create the model
    yardl init smoketest

    cd model
    yardl generate

    # Verify Python
    cd $scriptDir
    pip3 install numpy
    python3 python/run_smoketest.py
    if ($LastExitCode -ne 0) {
        throw "Python script failed"
    }

    # verify C++
    cd $scriptDir\cpp
    rm -Recurse -Force $scriptDir\cpp\build -ErrorAction SilentlyContinue
    mkdir -Force $scriptDir\cpp\build | Out-Null
    cd $scriptDir\cpp\build

    # Configure
    $toolchainFile = Join-Path $VcpkgPath scripts\buildsystems\vcpkg.cmake
    $configure_args = "..", "-DCMAKE_TOOLCHAIN_FILE=$toolchainFile"
    cmake $configure_args

    # Build
    cmake --build .

    # Run the binary we just built
    .\Debug\smoketest.exe

    # Verify that it produced the expected file
    if (!(Test-Path -Path "smoketest.h5"))
    {
        throw "The expected output file was not found"
    }

    echo "Adding unit test types to the model"
    cd ../..
    cp ../models/test/unittests.yml model/
    cp -r ../models/* ./
    cp _package.yml model/
    cd model
    yardl generate
    cd ../cpp/build
    cmake --build .
}
finally
{
    cd $location
}
